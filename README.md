# Index Mini Backtest API

A mini backtesting engine for running portfolio simulations using customizable rules (calendar, filters, weights) built with FastAPI, Pandas, and Pydantic.

## Features

- Custom or quarterly portfolio rebalancing dates
- Two filtering strategies:
  - Top N by data field
  - Value threshold filter
- Two weighting strategies:
  - Equal weight
  - Optimized weights within bounds
- Reads from Parquet files
- FastAPI + Swagger docs
- Lightweight, testable, and extendable

## Tech Stack

- Python 3.11
- FastAPI
- Pandas, NumPy
- PyArrow
- Pydantic
- Pytest

## Test Coverage
The project includes extensive tests that verify the main functionalities of the backtest engine:

Test 1: Basic Equal Weighting + Top N + Quarterly
Tests basic flow where a portfolio is rebalanced quarterly using Top-N securities with equal weighting.
Expected: Returns non-empty weights equally distributed among selected securities.

Test 2: Equal Weighting + Value Threshold + Quarterly
Tests equal weighting when securities are selected based on a minimum value threshold from the dataset.
Expected: Returns non-empty equal weights among securities meeting the threshold.

Test 3: Optimized Weighting + Top N
Tests true optimization with Top-N securities under lower and upper bound constraints.
Expected: Returns optimized weights satisfying bounds and maximizing Dáµ€w.

Test 4: Optimized Weighting + Value Threshold
Tests optimization after applying a value threshold filter resulting in a large set of securities.
Expected: Returns optimized weights if feasible, else safely returns empty if infeasible.

Test 5: Invalid Calendar Rule
Tests how the system handles invalid calendar rule input.
Expected: Returns HTTP 422 Unprocessable Entity error.

Test 6: No Securities After Filtering (Edge Case)
Tests the edge case where no securities pass the filter criteria.
Expected: Returns an empty weights dictionary gracefully without crashing.

## Example Test Case Outputs

You can view actual API JSON responses generated for each test case in the [examples/](examples/) folder.
These files demonstrate the real outputs generated by the API for different scenarios, including:

- Equal Weighting + Top-N
- Equal Weighting + Value Threshold
- Optimized Weighting + Top-N
- Optimized Weighting + Value Threshold
- Invalid Calendar Rule (error handling)
- No Securities After Filter (edge case)

Each JSON file corresponds to a test case and showcases the successful execution of the backtesting engine.

> **Note**:  
> Due to rounding weights to 6 decimal places for cleaner output, in some test cases the sum of portfolio weights may be approximately 1 rather than exactly 1.  
> This minor deviation is expected and acceptable in financial applications for numerical stability.

## How to Run

```bash
# Step 1: Clone the repository
git clone repo url
cd bita-backtest-api

# Step 2: Create and activate a virtual environment
python3.11 -m venv venv
# On Mac/Linux
source venv/bin/activate
# On Windows
venv\Scripts\activate

# Step 3: Install dependencies
pip install -r requirements.txt

# Step 4: Generate dummy data
python scripts/generate_data.py

# Step 5: Run the FastAPI server
uvicorn app.main:app --reload



